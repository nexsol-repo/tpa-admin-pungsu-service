name: CI/CD - TPA Admin API

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: tpa-admin-pungsu-api
  DEPLOY_PATH: /home/nex3/app/tpa-admin-pungsu-api

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Docker Image Build
        run: |
          echo "π³ Build Docker Images"
          docker build \
            --network=host \
            --build-arg NEXUS_URL=${{ secrets.NEXUS_URL }} \
            --build-arg NEXUS_USERNAME=${{ secrets.NEXUS_USERNAME }} \
            --build-arg NEXUS_PASSWORD=${{ secrets.NEXUS_PASSWORD }} \
            -t ${{ env.IMAGE_NAME }}:prod -f Dockerfile .

      - name: Prepare & Execute Deployment
        run: |
          mkdir -p ${{ env.DEPLOY_PATH }}
          
          # [μμ • ν¬μΈνΈ] νμΌ κ²½λ΅κ°€ scripts/deploy.sh μΈμ§€ ν™•μΈν•μ„Έμ”.
          cp docker-compose.yml ${{ env.DEPLOY_PATH }}/
          cp scripts/deploy.sh ${{ env.DEPLOY_PATH }}/
          chmod +x ${{ env.DEPLOY_PATH }}/deploy.sh
          
          # ν™κ²½ κ²°μ • (dev/prod)
          TARGET_ENV="dev"
          [[ "${{ github.ref_name }}" == "main" ]] && TARGET_ENV="prod"
          
          # λ°°ν¬ μ¤ν¬λ¦½νΈ μ‹¤ν–‰
          cd ${{ env.DEPLOY_PATH }}
          ./deploy.sh $TARGET_ENV

      - name: Cleanup Docker
        run: docker image prune -f